#!/usr/bin/env bin/rails runner

# Quick and dirty script to fetch old data and recalc competitions

competitions = {
  blind_date: {
    categories: [
      {name: "Category 1/2 Men"},
      {name: "Category 2/3 Men"},
      {name: "Category 3/4 Men"},
      {name: "Category 5 Men"},
      {name: "Junior Men 14-18"},
      {name: "Junior Men 9-13"},
      {name: "Junior Women 14-18"},
      {name: "Junior Women 9-13"},
      {name: "Masters Men 1/2 40+"},
      {name: "Masters Men 2/3 40+"},
      {name: "Masters Men 3/4 40+"},
      {name: "Masters Men 50+"},
      {name: "Masters Men 60+"},
      {name: "Singlespeed"},
      {name: "Stampede"},
      {name: "Women 1/2"},
      {name: "Women 3"},
      {name: "Women 4"},
      {name: "Women 5"}
    ],
    competition_id: 26_417,
    event_id: 26_208,
    rules: {
      maximum_events: -1,
      points_for_place: [15, 12, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
    }
  },
  cross_crusade: {
    categories: [
      {name: "Athena"},
      {name: "Clydesdale"},
      {name: "Elite Junior Men"},
      {name: "Elite Junior Women", maximum_events: -2},
      {name: "Junior Men 10-12"},
      {name: "Junior Men 13-14"},
      {name: "Junior Men 15-16"},
      {name: "Junior Men 17-18"},
      {name: "Junior Men 3/4/5"},
      {name: "Junior Men 9-12 3/4/5", reject: true},
      {name: "Junior Men 9"},
      {name: "Junior Women 10-12"},
      {name: "Junior Women 13-14"},
      {name: "Junior Women 15-16"},
      {name: "Junior Women 17-18"},
      {name: "Junior Women 3/4/5"},
      {name: "Junior Women 9-12 3/4/5", reject: true},
      {name: "Junior Women 9"},
      {name: "Masters 35+ 1/2"},
      {name: "Masters 35+ 3"},
      {name: "Masters 35+ 4"},
      {name: "Masters 50+"},
      {name: "Masters 60+"},
      {name: "Masters 70+"},
      {name: "Masters Women 35+ 1/2", maximum_events: -2},
      {name: "Masters Women 35+ 3", maximum_events: -2},
      {name: "Masters Women 50+", maximum_events: -2},
      {name: "Masters Women 60+", maximum_events: -2},
      {name: "Men 1/2"},
      {name: "Men 2/3"},
      {name: "Men 4"},
      {name: "Men 5"},
      {name: "Singlespeed Women"},
      {name: "Singlespeed"},
      {name: "Women 1/2"},
      {name: "Women 2/3", maximum_events: -2},
      {name: "Women 4", maximum_events: -2},
      {name: "Women 5", maximum_events: -2}
    ],
    competition_id: 26_440,
    event_id: 25_896,
    rules: {
      maximum_events: -1,
      minimum_events: 3,
      points_for_place: [26, 20, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
    }
  },
  gpcd: {
    categories: [
      {name: "Athena"},
      {name: "Category 1/2 35+ Men"},
      {name: "Category 1/2 35+ Women"},
      {name: "Category 1/2 Men"},
      {name: "Category 1/2 Women"},
      {name: "Category 2/3 Men"},
      {name: "Category 2/3 Women"},
      {name: "Category 3 35+ Men"},
      {name: "Category 3 35+ Women"},
      {name: "Category 3 Women"},
      {name: "Category 4 35+ Men"},
      {name: "Category 4 Men"},
      {name: "Category 4 Women"},
      {name: "Category 5 Men"},
      {name: "Category 5 Women"},
      {name: "Clydesdale"},
      {name: "Elite Junior Men"},
      {name: "Elite Junior Women"},
      {name: "Junior Men 3/4/5"},
      {name: "Junior Women 3/4/5"},
      {name: "Masters 50+ Men"},
      {name: "Masters 50+ Women"},
      {name: "Masters 60+ Men"},
      {name: "Masters 60+ Women"},
      {name: "Singlespeed Men"},
      {name: "Singlespeed Women"}
    ],
    competition_id: 26_421,
    event_id: 26_278,
    rules: {
      maximum_events: -1,
      minimum_events: 4,
      points_for_place: [100, 80, 60, 50, 45, 40, 36, 32, 29, 26, 24, 22, 20, 18, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
    }
  },
  tabor: {
    categories: [
      {name: "Senior Men"},
      {name: "Category 3 Men"},
      {name: "Category 4 Men"},
      {name: "Category 4/5 Women"},
      {name: "Category 5 Men"},
      {name: "Masters Men 50+"},
      {name: "Masters Men 40+"},
      {name: "Senior Women"}
    ],
    competition_id: 26_299,
    event_id: 26_072,
    rules: {
      double_points_for_last_event: true,
      points_for_place: [100, 70, 50, 40, 36, 32, 28, 24, 20, 16, 15, 14, 13, 12, 11]
    }
  }
}

def fetch_data
  Dir.chdir("tmp/db") do
    unless File.exist?("bushtit_obra_sql")
      puts `scp nutcracker.rocketsurgeryllc.com:/mnt/bak4/daily/bushtit_obra_sql-2018-12-05.tar.gz .`
      puts `tar xf bushtit_obra_sql-2018-12-05.tar.gz`
    end
  end
end

def recreate_databases
  puts `spring stop`
  puts `mysql -u root -e 'set foreign_key_checks = 0; drop database if exists obra_development'`
  puts `mysql -u root -e 'set foreign_key_checks = 0; drop database if exists obra_test'`
  puts `bundle exec rake db:setup RAILS_ENV=development`
  puts `mysql -u root obra_development < tmp/db/production.sql`
  puts `bundle exec rake db:migrate`
end

def destroy_calculations
  ResultSource.destroy_all
  Result.where(year: 2019).destroy_all
  Result.where("created_at > ?", Date.new(2019)).destroy_all
  Race.where("created_at > ?", Date.new(2019)).destroy_all

  Calculations::V3::Calculation.all.each do |calc|
    calc.event&.destroy_races
    calc.event&.destroy!
    calc.destroy!
  end
end

def create_calculations(competitions)
  calculations = []

  competitions.values.each do |competition|
    event = Event.find(competition[:event_id])
    calculation = event.calculations.create!(competition[:rules])
    competition[:categories].each do |category_definition|
      category = Category.find_or_create_by(name: category_definition[:name])
      calculation_category = Calculations::V3::Category.new(category: category, maximum_events: category_definition[:maximum_events], reject: category_definition[:reject] || false)
      calculation.calculation_categories << calculation_category
    end
    calculations << calculation
  end

  calculations
end

def compare_results(competitions)
  competitions.values.each do |competition|
    expected_event = Competitions::Competition.find(competition[:competition_id])
    actual_event = Event.find(competition[:event_id]).calculations.first.event
    compare_event_results expected_event, actual_event
  end
end

def compare_event_results(expected_event, actual_event)
  expected_races = expected_event.races.sort
  actual_races = actual_event.races.reject(&:rejected?).select(&:visible?).sort

  expected_categories = expected_races.map(&:name).sort
  actual_categories = actual_races.map(&:name).sort

  if expected_categories != actual_categories
    puts "#{actual_event.full_name} races"
    puts "expected: #{expected_categories}"
    puts "actual:   #{actual_categories}"
    if expected_categories.size > actual_categories.size
      puts "diff:     #{expected_categories - actual_categories}"
    else
      puts "diff:     #{actual_categories - expected_categories}"
    end
  end

  expected_races.each do |expected_race|
    actual_race = actual_races.detect { |r| r.name == expected_race.name }
    next unless actual_race

    # GPCD Elite Juniors accidentally skipped in 2018
    if expected_race.id == 614969 || expected_race.id == 614970
      return
    end

    expected_results = expected_race.results.reject { |r| r.points == 0 }.map { |result| [result.place, result.person_id, result.points]}.sort
    actual_results = actual_race.results
                      .reject { |r| r.points == 0 }
                      .reject(&:rejected?)
                      .select(&:visible?)
                      .map { |result| [result.place, result.person_id, result.points]}
                      .sort

    if expected_results.size != actual_results.size
      puts "Expected #{actual_race.name} to have #{expected_results.size} results, but has #{actual_results.size}"
    end

    if expected_results != actual_results
      puts "#{expected_event.full_name} #{expected_event.id} #{expected_race.name} #{expected_race.id} results"
      puts "expected:"
      pp expected_results
      puts "actual:"
      pp actual_results
      puts "diff:"
      if expected_results.size > actual_results.size
        pp expected_results - actual_results
      else
        pp actual_results - expected_results
      end
    end
  end
end

# fetch_data
# recreate_databases
destroy_calculations
calculations = create_calculations(competitions)
calculations.map(&:source_event).each(&:update_date)
calculations.each(&:calculate!)
compare_results(competitions)
