include_partial 'fixtures'
include_partial 'admin_login'

open '/admin/racers'
assert_text_present "Enter part of a racer's name"
type "name", "a"
submit_and_wait("search_form")

assert_text "warn", ""
assert_text "notice", ""

assert_table "racers_table", 1, 0, "glob:Molly Cameron*"
assert_table "racers_table", 2, 0, "glob:Mark Matson*"
assert_table "racers_table", 3, 0, "glob:Alice Pennington*"
assert_table "racers_table", 4, 0, "glob:Ryan Weaver*"

assert_table "racers_table", 1, 1, "glob:Vanilla*"
assert_table "racers_table", 2, 1, "glob:Kona*"
assert_table "racers_table", 3, 1, "glob:Gentle Lovers*"
assert_table "racers_table", 4, 1, "glob:Gentle Lovers*"

assert_table "racers_table", 1, 2, "glob:Mollie Cameron*"
assert_table "racers_table", 2, 2, ""
assert_table "racers_table", 3, 2, ""
assert_table "racers_table", 4, 2, ""

assert_table "racers_table", 1, 3, "202"
assert_table "racers_table", 2, 3, "340"
assert_table "racers_table", 3, 3, "230"
assert_table "racers_table", 4, 3, "341"

assert_table "racers_table", 1, 4, ""
assert_table "racers_table", 2, 4, ""
assert_table "racers_table", 3, 4, ""
assert_table "racers_table", 4, 4, "437"

@molly_id = Racer.find_by_name("Molly Cameron").id
@weaver_id = Racer.find_by_name("Ryan Weaver").id
@matson_id = Racer.find_by_name("Mark Matson").id
@matson = Racer.find_by_name("Mark Matson")
@alice_id = Racer.find_by_name("Alice Pennington").id
assert_checked "racer_member_#{@molly_id}"
assert_checked "racer_member_#{@weaver_id}"
assert_checked "racer_member_#{@matson_id}"
assert_checked "racer_member_#{@alice_id}"

click "racer_#{@alice_id}_name"
wait_for_element_present "racer_#{@alice_id}_name-inplaceeditor"

type "css=.editor_field", "A Penn"
submit "css=.inplaceeditor-form"
wait_for_element_not_present "racer_#{@alice_id}_name-inplaceeditor"

refresh_and_wait
assert_table "racers_table", 3, 0, "glob:A P*"

click_and_wait "css=a[href='/admin/results/racer/#{@molly_id}']"
assert_title "*Admin: Results: Molly Cameron"

open '/admin/racers'
click_and_wait "css=a[href='/admin/results/racer/#{@weaver_id}']"
assert_title "*Admin: Results: Ryan Weaver"

open '/admin/racers'
click_and_wait "css=a[href='/admin/racers/#{@matson_id}/edit']"
assert_title "*Admin: Racers: Mark Matson"
type "racer_home_phone", "411 911 1212"
click_and_wait "save"

open '/admin/racers'
click_and_wait "css=a[href='/admin/racers/new']"
assert_title "*Admin: Racers: New Racer"

open "/admin/racers/#{@matson.id}/edit"
assert_text_present "Mark Matson"
click "destroy_number_#{@matson.race_numbers.first.id}"
wait_for_element_not_present "destroy_number_#{@matson.race_numbers.first.id}"
click_and_wait "save"

assert_text_not_present "error"
assert_text_not_present "Unknown action"
assert_text_not_present "Couldn't find RaceNumber"

assert_location "*/admin/racers/#{@matson.id}/edit"
