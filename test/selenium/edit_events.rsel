include_partial "fixtures"
include_partial "admin_login"

click_and_wait "link=New Event"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"

type "event_name", "Sausalito Criterium"
click_and_wait "save"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"
assert_text_present "Created Sausalito Criterium"

open "/admin/events"
assert_text_present "Sausalito Criterium"
click_and_wait "link=Sausalito Criterium"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"

assert_value "event_promoter_id", ""
click_and_wait "save"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"

open "/admin/events"
assert_text_present "Sausalito Criterium"
click_and_wait "link=Sausalito Criterium"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"

assert_value "event_promoter_id", ""

click_and_wait "link=Delete"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"

assert_text_present "Deleted Sausalito Criterium"

open "/admin/events?year=2004"
assert_text_not_present "Sausalito Criterium"

open "/admin/events?year=2003"

click_and_wait "link=Kings Valley Road Race"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"
assert_text_present "Senior Men Pro 1/2"
assert_text_present "Senior Men 3"

kings_valley = Event.find_by_name_and_date('Kings Valley Road Race', '2003-12-31')
click "id=destroy_race_#{kings_valley.races.first.id}"
wait_for_not_visible "id=race_#{kings_valley.races.first.id}_row"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"

# TODO Fix Safari: it doesn't like the JS here
click "id=destroy_races"
wait_for_confirmation("glob:Really delete*")
wait_for_not_visible "id=destroy_races_progress"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"

open "/admin/events?year=2003"

click_and_wait "link=Kings Valley Road Race"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"
assert_text_not_present "Senior Men Pro 1/2"
assert_text_not_present "Senior Men 3"

click_and_wait "new_event"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"
assert_text_present "Kings Valley Road Race"
assert_value "event_parent_id", kings_valley.id

type "event_name", "Fancy New Child Event"
click_and_wait "save"
assert_value "event_parent_id", kings_valley.id
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"

open "/admin/events/#{kings_valley.id}/edit"
assert_text_present "Fancy New Child Event"
assert_text_not_present "regexp:Template is missing|Unknown action|Routing Error|RuntimeError|error occurred|Application Trace|RecordNotFound"
assert_not_title "regexp:Exception"
