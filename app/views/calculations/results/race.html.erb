<% @page_title = "Results: #{@race.event.date.year}: #{@race.full_name}" %>

<% cache cache_key(@race) do %>
  <h2><%= @race.full_name %></h2>

  <div class="row event_info">
    <%= @race.date.to_formatted_s(:long) %>

    <p>Part of the <%= link_to @race.event.full_name, event_results_path(@race.event) %></p>
  </div>

  <%- if @race.results.empty? -%>
  <p class="event_notes">No results</p>
  <%- end -%>

  <p class="created_updated">Updated <%= @race.updated_at.to_formatted_s :long_and_friendly_date_and_time %></p>

  <% ActiveSupport::Notifications.instrument "@race.results.calculations.racing_on_rails", race_id: @race.id, race_name: @race.full_name do %>
    <% if @race.distance.present? && @race.distance > 0 %> (<%= @race.distance %> miles)<% end %>

    <%- if @race.rejected? -%>
      <p class="event_notes">
        <%= t @race.rejection_reason, category: @race.category_name %>
      </p>
    <% end -%>

    <%- @race.results.sort.each do |result| -%>
      <%- if result.numeric_place.zero? -%>
        <%- if @race.event.calculation.team? -%>
          <h3><%= link_to(result.team_name, team_results_year_path(result.team, result.year)) if result.team_id %></h3>
        <%- else -%>
          <h3><%= link_to(result.person_name, person_results_year_path(result.person, result.year)) if result.person_id %></h3>
        <%- end -%>
      <%- else -%>
        <%- if @race.event.calculation.team? -%>
          <h3><%= result.numeric_place.ordinalize %> &mdash; <%=
            link_to(result.team_name, team_results_year_path(result.team, result.year)) if result.team_id
            %></h3>
        <%- else -%>
          <h3><%= result.numeric_place.ordinalize %> &mdash; <%=
            link_to(result.person_name, person_results_year_path(result.person, result.year)) if result.person_id
            %></h3>
        <%- end -%>
      <%- end -%>
      <table class="base table table-striped results">
        <thead>
          <tr>
            <th class="place"></th>
            <th class="event">Event</th>
            <th class="category">Category</th>
            <th class="date">Date</th>
            <%- if @race.event.calculation.team? -%>
            <th class="name">Name</th>
            <%- end -%>
            <th class="rejection_reason"></th>
            <th class="points">Points</th>
          </tr>
        </thead>
        <tbody>
          <%- result.sources.sort.each do |source| -%>
            <tr>
              <td class="place"><%= source.source_result.place %></td>
              <td class="event"><%= source.source_result.event_full_name %></td>
              <td class="category"><%= source.source_result.race_name %></td>
              <td class="date"><%= source.source_result.event_date_range_s %></td>
              <%- if @race.event.calculation.team? -%>
              <td class="name"><%= source.source_result.name %></td>
              <%- end -%>
              <td class="rejection_reason"><%= t source.rejection_reason,
                category: source.source_result.category_name,
                discipline: source.source_result.discipline_name,
                minimum_events: @race.event.calculation.rules.minimum_events,
                racing_association: RacingAssociation.current.short_name,
                results_per_event: @race.event.calculation.rules.results_per_event %></td>
              <td class="points"><%= source.points %></td>
            </tr>
          <%- end -%>
          <tr class="total">
            <%- if @race.event.calculation.team? -%>
            <td colspan="7" class="points total"><%= result.points %></td>
            <%- else -%>
            <td colspan="6" class="points total"><%= result.points %></td>
            <%- end -%>
          </tr>
        </tbody>
      </table>
    <%- end -%>
  <%- end -%>
<%- end -%>
